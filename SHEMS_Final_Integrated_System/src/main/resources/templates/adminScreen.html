<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SHEMS Admin Dashboard</title>

    <style>
        /* (ALL YOUR EXISTING CSS — UNCHANGED) */
        :root {
            --bg:#f5f7fb;
            --card:#ffffff;
            --text:#1f2937;
            --muted:#6b7280;
            --primary:#2563eb;
            --sidebar:#0f172a;
            --danger:#dc2626;
            --success:#16a34a;
            --warning:#f59e0b;
        }

        body.dark {
            --bg:#0b1220;
            --card:#111827;
            --text:#f8fafc;
            --muted:#9ca3af;
            --primary:#3b82f6;
        }

        body {
            margin:0;
            font-family:Segoe UI, sans-serif;
            background:var(--bg);
            color:var(--text);
            transition:.3s;
        }

        .sidebar {
            width:220px;
            height:100vh;
            background:var(--sidebar);
            color:white;
            position:fixed;
            padding-top:30px;
        }

        .sidebar h2 {
            text-align:center;
            margin-bottom:30px;
            letter-spacing:1px;
        }

        .sidebar a {
            display:block;
            color:#cbd5e1;
            padding:12px 25px;
            text-decoration:none;
            font-size:15px;
        }

        .sidebar a:hover {
            background:#1e293b;
            color:white;
        }

        .header {
            margin-left:220px;
            background:var(--primary);
            color:white;
            padding:20px 30px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .header h1 {
            margin:0;
            font-size:22px;
        }

        .theme-switch {
            width:46px;
            height:24px;
            background:#bfdbfe;
            border-radius:20px;
            position:relative;
            cursor:pointer;
            margin-left:20px;
        }

        .theme-switch::before {
            content:"";
            position:absolute;
            width:18px;
            height:18px;
            background:white;
            border-radius:50%;
            top:3px;
            left:3px;
            transition:.3s;
        }

        body.dark .theme-switch {
            background:#60a5fa;
        }

        body.dark .theme-switch::before {
            transform:translateX(22px);
        }

        .main {
            margin-left:220px;
            padding:30px;
        }

        .alert-banner {
            background:#fff7ed;
            border-left:6px solid var(--danger);
            padding:16px 20px;
            border-radius:10px;
            margin-bottom:25px;
            box-shadow:0 4px 10px rgba(0,0,0,.06);
        }

        .alert-banner h3 {
            margin:0 0 6px;
            color:var(--danger);
        }

        .alert-banner p {
            margin:0;
            font-size:14px;
            color:var(--text);
        }

        .cards {
            display:grid;
            grid-template-columns:repeat(4,1fr);
            gap:20px;
            margin-bottom:30px;
        }

        .card {
            background:var(--card);
            padding:20px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,.08);
        }

        .card h3 {
            margin:0;
            font-size:14px;
            color:var(--muted);
        }

        .card p {
            font-size:28px;
            margin:8px 0 0;
            font-weight:600;
            color:var(--primary);
        }

        table {
            width:100%;
            border-collapse:collapse;
            background:var(--card);
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 4px 12px rgba(0,0,0,.08);
            margin-top:10px;
        }

        th, td {
            padding:12px 15px;
            text-align:left;
        }

        th {
            background:#e0e7ff;
            color:#1e3a8a;
            font-size:14px;
        }

        tr:nth-child(even) {
            background:rgba(0,0,0,0.02);
        }

        .delete-btn {
            color:var(--danger);
            font-weight:600;
            text-decoration:none;
        }

        .manage-btn {
            margin-top:25px;
            display:inline-block;
            background:var(--primary);
            color:white;
            padding:10px 18px;
            border-radius:8px;
            text-decoration:none;
            font-weight:600;
        }

        .badge-high {
            background:#fee2e2;
            color:var(--danger);
            padding:5px 12px;
            border-radius:20px;
            font-size:12px;
            font-weight:600;
        }

        .badge-normal {
            background:#dcfce7;
            color:var(--success);
            padding:5px 12px;
            border-radius:20px;
            font-size:12px;
            font-weight:600;
        }
    </style>

    <script>
        function toggleTheme() {
            document.body.classList.toggle("dark");
            localStorage.setItem(
                "theme",
                document.body.classList.contains("dark") ? "dark" : "light"
            );
        }

        window.onload = function () {
            if (localStorage.getItem("theme") === "dark") {
                document.body.classList.add("dark");
            }
        };

        // ✅ DELETE CONFIRMATION
        function confirmDelete(link) {
            const userName = link.getAttribute("data-username");

            return confirm(
                "Delete User Account\n\n" +
                "User: " + userName + "\n\n" +
                "This will permanently remove:\n" +
                "• All devices\n" +
                "• Energy records\n" +
                "• Automation schedules\n\n" +
                "This action cannot be undone.\n\n" +
                "Do you want to continue?"
            );
        }
    </script>
</head>

<body>

<div class="sidebar">
    <h2>SHEMS</h2>
	<a href="/admin">Home</a>
    <a href="/adminScreen">Dashboard</a>
    <a href="/adminScreen/devices">Devices</a>
	<a href="/admin/policies">Energy Policies</a>
    <a href="/admin/analytics">Analytics</a>
    <a href="/logout">Logout</a>
</div>

<div class="header">
    <h1>Admin Dashboard</h1>
    <div style="display:flex;align-items:center;gap:15px;">
        <div>
            Logged in as: <b th:text="${userDetails}"></b>
        </div>
        <div class="theme-switch" onclick="toggleTheme()" title="Toggle Theme"></div>
    </div>
</div>

<div class="main">

    <div th:if="${!#lists.isEmpty(highUsageUsers)}" class="alert-banner">
        <h3>⚠ High Energy Usage Detected</h3>
        <p>
            The following users have exceeded normal energy usage today:
            <span th:each="u, iter : ${highUsageUsers}">
                <b th:text="${u.name}"></b>
                <span th:if="${!iter.last}">, </span>
            </span>
        </p>
    </div>

    <div class="cards">
        <div class="card">
            <h3>Total Users</h3>
            <p th:text="${totalUsers}">0</p>
        </div>
        <div class="card">
            <h3>Total Devices</h3>
            <p th:text="${totalDevices}">0</p>
        </div>
        <div class="card">
            <h3>Active Devices</h3>
            <p th:text="${activeDevices}">0</p>
        </div>
        <div class="card">
            <h3>Inactive Devices</h3>
            <p th:text="${inactiveDevices}">0</p>
        </div>
    </div>

    <h2>Registered Users</h2>

    <table>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Total Energy (kWh)</th>
            <th>Peak Usage</th>
            <th>Action</th>
        </tr>

        <tr th:each="user : ${users}">
            <td th:text="${user.name}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${userEnergyMap[user.id] != null ? #numbers.formatDecimal(userEnergyMap[user.id],1,3) + ' kWh' : '0 kWh'}"></td>
            <td>
                <span th:if="${userPeakMap[user.id]}" class="badge-high">⚠ High</span>
                <span th:unless="${userPeakMap[user.id]}" class="badge-normal">Normal</span>
            </td>
            <td>
                <a th:href="@{'/adminScreen/deleteUser/' + ${user.id}}"
                   th:attr="data-username=${user.name}"
                   class="delete-btn"
                   onclick="return confirmDelete(this)">
                    Delete
                </a>
            </td>
        </tr>
    </table>

    <a href="/adminScreen/devices" class="manage-btn">Manage All Devices</a>

</div>

</body>
</html>
