<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Admin Analytics | SHEMS</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --primary:#2563eb;
  --sidebar:#0f172a;
  --border:#e2e8f0;
  --danger:#dc2626;
  --success:#16a34a;
  --warn:#f59e0b;
}

body.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#f8fafc;
  --muted:#9ca3af;
  --primary:#3b82f6;
}

body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}

/* Sidebar */
.sidebar{
 width:220px;
 height:100vh;
 background:var(--sidebar);
 color:white;
 position:fixed;
 padding-top:30px;
}
.sidebar h2{
 text-align:center;
 margin-bottom:30px;
 letter-spacing:1px;
}
.sidebar a{
 display:block;
 color:#cbd5e1;
 padding:12px 25px;
 text-decoration:none;
 font-size:15px;
}
.sidebar a:hover{background:#1e293b;color:white}

/* Header */
.header{
 margin-left:220px;
 background:var(--primary);
 color:white;
 padding:20px 30px;
 display:flex;
 justify-content:space-between;
 align-items:center;
}
.header h1{margin:0;font-size:22px}

/* Theme Switch */
.theme-switch{
 width:46px;
 height:24px;
 background:#bfdbfe;
 border-radius:20px;
 position:relative;
 cursor:pointer;
}
.theme-switch::before{
 content:"";
 position:absolute;
 width:18px;
 height:18px;
 background:white;
 border-radius:50%;
 top:3px;
 left:3px;
 transition:.3s;
}
body.dark .theme-switch{background:#60a5fa;}
body.dark .theme-switch::before{transform:translateX(22px);}

/* Main */
.main{
 margin-left:220px;
 padding:30px;
}

/* Cards */
.card{
 background:var(--card);
 border:1px solid var(--border);
 border-radius:14px;
 padding:24px;
 margin-bottom:30px;
 box-shadow:0 4px 10px rgba(0,0,0,.05);
}

.stats{
 display:flex;
 gap:20px;
 flex-wrap:wrap;
}

.stat-box{
 flex:1;
 min-width:200px;
 background:#eef2ff;
 padding:18px;
 border-radius:12px;
}
.stat-box h3{
 margin:0;
 font-size:14px;
 color:var(--muted);
}
.stat-box p{
 margin:6px 0 0;
 font-size:22px;
 font-weight:bold;
 color:var(--primary);
}

/* User rows */
.user-row{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:10px 0;
 border-bottom:1px solid var(--border);
}

.badge-high{
 background:#fee2e2;
 color:var(--danger);
 padding:6px 12px;
 border-radius:20px;
 font-size:12px;
 font-weight:600;
}

.badge-normal{
 background:#dcfce7;
 color:var(--success);
 padding:6px 12px;
 border-radius:20px;
 font-size:12px;
 font-weight:600;
}

/* Recommendation Alerts */
.alert{
 padding:14px 18px;
 border-radius:10px;
 margin-bottom:12px;
 font-size:14px;
}
.alert.warn{background:#fffbeb;border-left:6px solid var(--warn);}
.alert.danger{background:#fef2f2;border-left:6px solid var(--danger);}
.alert.success{background:#ecfdf5;border-left:6px solid var(--success);}

canvas{margin-top:20px;}
</style>

<script>
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark") ? "dark":"light");
}
window.onload=function(){
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
  }
};
</script>
</head>

<body>

<div class="sidebar">
 <h2>SHEMS</h2>
 <a href="/admin">Home</a>
 <a href="/adminScreen">Dashboard</a>
 <a href="/adminScreen/devices">Devices</a>
 <a href="/admin/policies">Energy Policies</a>
 <a href="/admin/analytics" style="background:#1e293b;color:white;">Analytics</a>
 <a href="/logout">Logout</a>
</div>

<div class="header">
 <h1>Admin Energy Analytics</h1>
 <div class="theme-switch" onclick="toggleTheme()"></div>
</div>

<div class="main">

  <!-- SYSTEM STATS -->
  <div class="card">
    <h2>System Overview</h2>
    <div class="stats">
      <div class="stat-box">
        <h3>Total Energy Today</h3>
        <p th:text="${#numbers.formatDecimal(totalEnergyToday,1,2)} + ' kWh'"></p>
      </div>
      <div class="stat-box">
        <h3>Total Energy This Week</h3>
        <p th:text="${#numbers.formatDecimal(totalEnergyThisWeek,1,2)} + ' kWh'"></p>
      </div>
      <div class="stat-box">
        <h3>Active Devices</h3>
        <p th:text="${activeDevices}"></p>
      </div>
    </div>
  </div>

  <!-- TOP DEVICES -->
  <div class="card">
    <h2>Top 5 Energy Consuming Devices (Today)</h2>
    <canvas id="topDevicesChart"></canvas>
  </div>

  <!-- USER USAGE -->
  <div class="card">
    <h2>User Energy Usage Status</h2>
    <div th:each="entry : ${userPeakMap}" class="user-row">
        <span th:text="${userNames[entry.key]}"></span>
        <span th:if="${entry.value}" class="badge-high">High Usage</span>
        <span th:unless="${entry.value}" class="badge-normal">Normal</span>
    </div>
  </div>

  <!-- SYSTEM RECOMMENDATIONS -->
  <div class="card">
    <h2>Smart System Recommendations</h2>
    <div th:each="rec : ${systemRecommendations}"
         th:class="'alert ' + 
           (${rec.key.contains('High') ? 'danger' : 
             (rec.key.contains('Spike') or rec.key.contains('Many') ? 'warn' : 'success')})">
        <b th:text="${rec.key}"></b><br>
        <span th:text="${rec.value}"></span>
    </div>
  </div>

</div>

<script th:inline="javascript">
const labels = [[${topDevices.keySet()}]];
const data = [[${topDevices.values()}]];

new Chart(document.getElementById('topDevicesChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Energy (kWh)',
            data: data,
            borderWidth: 1,
            backgroundColor: '#3b82f6'
        }]
    }
});
</script>

</body>
</html>
