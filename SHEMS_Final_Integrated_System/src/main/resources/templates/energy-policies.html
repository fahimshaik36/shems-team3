<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>SHEMS – Energy Policies</title>

<style>
/* ===== SAME CSS SYSTEM AS ADMIN DASHBOARD ===== */
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --primary:#2563eb;
  --sidebar:#0f172a;
  --danger:#dc2626;
  --success:#16a34a;
}

body.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#f8fafc;
  --muted:#9ca3af;
  --primary:#3b82f6;
}

body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}

/* ===== Sidebar ===== */
.sidebar{
  width:220px;
  height:100vh;
  background:var(--sidebar);
  color:white;
  position:fixed;
  padding-top:30px;
}
.sidebar h2{
  text-align:center;
  margin-bottom:30px;
}
.sidebar a{
  display:block;
  color:#cbd5e1;
  padding:12px 25px;
  text-decoration:none;
  font-size:15px;
}
.sidebar a:hover,
.sidebar a.active{
  background:#1e293b;
  color:white;
}

/* ===== Header ===== */
.header{
  margin-left:220px;
  background:var(--primary);
  color:white;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h1{
  margin:0;
  font-size:22px;
}

/* ===== Theme Toggle ===== */
.theme-switch{
  width:46px;
  height:24px;
  background:#bfdbfe;
  border-radius:20px;
  position:relative;
  cursor:pointer;
}
.theme-switch::before{
  content:"";
  position:absolute;
  width:18px;
  height:18px;
  background:white;
  border-radius:50%;
  top:3px;
  left:3px;
  transition:.3s;
}
body.dark .theme-switch{background:#60a5fa;}
body.dark .theme-switch::before{transform:translateX(22px);}

/* ===== Main ===== */
.main{
  margin-left:220px;
  padding:30px;
}

/* ===== Card ===== */
.card{
  background:var(--card);
  padding:24px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  margin-bottom:25px;
}
.card h3{
  margin-top:0;
  margin-bottom:20px;
}

/* ===== Info Banner ===== */
.info-banner{
  background:#eef2ff;
  border-left:5px solid var(--primary);
  padding:16px 20px;
  border-radius:10px;
  margin-bottom:25px;
}

/* ===== Form ===== */
.form-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:20px 24px;
}
.form-group{
  display:flex;
  flex-direction:column;
}
label{
  font-size:14px;
  font-weight:600;
}
input, select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #e5e7eb;
  box-sizing:border-box;
}
.full-row{grid-column:1 / -1;}
.form-actions{
  grid-column:1 / -1;
  display:flex;
  justify-content:flex-end;
}

/* ===== Buttons ===== */
.btn{
  background:var(--primary);
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.toggle-link{
  color:var(--primary);
  font-weight:600;
  text-decoration:none;
}

/* ===== Table ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
th, td{
  padding:12px 15px;
  text-align:left;
}
th{
  background:#e0e7ff;
  color:#1e3a8a;
  font-size:14px;
}
tr:nth-child(even){
  background:rgba(0,0,0,0.02);
}

/* ===== Status ===== */
.status-on{color:var(--success);font-weight:600;}
.status-off{color:var(--danger);font-weight:600;}
.active-now{color:var(--success);font-weight:700;}
.inactive-now{color:var(--muted);}
</style>

<script>
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("dark") ? "dark":"light"
  );
}

window.onload = () => {
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
  }
  updateActivePolicies();          // NEW
  setInterval(updateActivePolicies, 30000); // NEW
};

// ================================
// NEW — Active Now auto-check
// ================================
function updateActivePolicies(){
  fetch("/admin/policies/status")
    .then(res => res.json())
    .then(activeIds => {
      document.querySelectorAll("tr[data-policy-id]").forEach(row => {
        const id = Number(row.dataset.policyId);
        const cell = row.querySelector(".active-cell");

        if(activeIds.includes(id)){
          cell.innerHTML = "<span class='active-now'>YES</span>";
        } else {
          cell.innerHTML = "<span class='inactive-now'>—</span>";
        }
      });
    })
    .catch(() => console.log("Policy status check failed"));
}
</script>
</head>

<body>

<div class="sidebar">
  <h2>SHEMS</h2>
  <a href="/admin">Home</a>
  <a href="/adminScreen">Dashboard</a>
  <a href="/adminScreen/devices">Devices</a>
  <a href="/admin/policies" class="active">Energy Policies</a>
  <a href="/admin/analytics">Analytics</a>
  <a href="/logout">Logout</a>
</div>

<div class="header">
  <h1>Admin – Energy Policies</h1>
  <div class="theme-switch" onclick="toggleTheme()"></div>
</div>

<div class="main">

<div class="info-banner">
  <h3>Energy Policy Enforcement</h3>
  <p>
    During the selected time window, devices exceeding the energy threshold
    will be <b>automatically turned OFF</b>.
  </p>
</div>

<div class="card">
  <h3>Create Energy Policy</h3>

  <form th:action="@{/admin/policies/add}" method="post" th:object="${policy}">
    <div class="form-grid">

      <div class="form-group">
        <label>Policy Name</label>
        <input type="text" th:field="*{policyName}" required>
      </div>

      <div class="form-group">
        <label>Energy Threshold (kWh)</label>
        <input type="number" step="0.01" th:field="*{energyThreshold}" required>
      </div>

      <div class="form-group">
        <label>Start Time</label>
        <input type="time" th:field="*{startTime}" required>
      </div>

      <div class="form-group">
        <label>End Time</label>
        <input type="time" th:field="*{endTime}" required>
      </div>

      <div class="form-group full-row">
        <label>Scope</label>
        <select th:field="*{scope}">
          <option value="ALL_USERS">All Users</option>
          <option value="HIGH_USAGE_USERS">High Usage Users</option>
        </select>
      </div>

      <div class="form-actions">
        <button class="btn">Create Policy</button>
      </div>

    </div>
  </form>
</div>

<div class="card">
  <h3>Existing Policies</h3>

  <table>
    <tr>
      <th>Name</th>
      <th>Time Window</th>
      <th>Threshold</th>
      <th>Scope</th>
      <th>Status</th>
      <th>Active Now</th>
      <th>Action</th>
    </tr>

    <tr th:if="${#lists.isEmpty(policies)}">
      <td colspan="7" style="text-align:center;color:var(--muted)">
        No energy policies configured.
      </td>
    </tr>

    <tr th:each="p : ${policies}" th:attr="data-policy-id=${p.id}">
      <td th:text="${p.policyName}"></td>
      <td th:text="${p.startTime + ' - ' + p.endTime}"></td>
      <td th:text="${p.energyThreshold + ' kWh'}"></td>
      <td th:text="${p.scope}"></td>

      <td>
        <span th:if="${p.enabled}" class="status-on">ENABLED</span>
        <span th:unless="${p.enabled}" class="status-off">DISABLED</span>
      </td>

      <td class="active-cell">
        <span class="inactive-now">—</span>
      </td>

      <td>
        <a th:href="@{'/admin/policies/toggle/' + ${p.id}}" class="toggle-link">
          Toggle
        </a>
      </td>
    </tr>
  </table>
</div>

</div>
</body>
</html>
